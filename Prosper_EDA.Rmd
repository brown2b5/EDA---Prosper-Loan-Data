Prosper Loan Exploratory Data Analysis by Brandon Brown
========================================================

> Prosper is a peer-to-peer lending marketplace in the United States which 
provides a platform for borrowers and lenders (Reference 1). Borrowers can 
apply for a fixed-rate, fixed-term loan of between $2,000 and $35,000 and individuals/institutions can invest in loans which generate attractive returns (Reference 1). Data is available on Prosper loans (Reference 2). This data 
includes interest rates, borrower employment status, borrower income, loan 
amount, borrower credit history and many other variables (Reference 3). The 
purpose of this project is to explore the data to determine which conditions 
might be associated with whether a borrower will be successful in paying back 
the original loan amount and interest. I expect to see which borrower employment status, credit score, debt to income ratio and other loan variables are most associated with those who default on their loans and who successfully complete 
their loan payments.

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Loading all of the packages I will use in this project. I will be using 
# ggplot2 to construct plots (Reference 1), knitr to put the R markdown document into an HTML document (Reference 2) and dplyr to mutate and transform the data (Reference 3).  I had to add a repos section to get the knitting of the html 
# file to complete (Reference 4).  

# NOTE ABOUT REFERENCES: At the end of this RMD file I have two Resources 
# sections.  The first is inside of an R chunck and is only for code inside R chuncks.  The second is outside the R chunck and is only for analyses and 
# paragraphs outside the R chuncks.  I did this so that references for code 
# inside the R chuncks wouldn't be visible in a knitted HTML file if users 
# want to knit together the file (because the R chuncks themselves won't be visible). 


install.packages("ggplot2", dependencies = T, 
                 repos = "http://cran.us.r-project.org") 
install.packages("knitr", dependencies = T, 
                 repos = "http://cran.us.r-project.org")
install.packages("dplyr", dependencies = T, 
                 repos = "http://cran.us.r-project.org")

# I set echo, message and warning to all be false so that I wouldn't see the 
# code in the HTML document or any warning messages (Reference 5)

# Load the libraries using the library function.  Note that you can use ? in 
# front of any command I use to see what the command does.  This tells what the command does (Reference 6).

library(ggplot2)
library(knitr)
library(dplyr)

# Get and set working directory (Reference 7)
# NOTE: For users wishing to contribute, you will need to set the path to that 
# you have cloned the project to inside the parentheses in setwd.
getwd()

# I used the paste function because my file name was too long and I needed
# to shorten it to below 80 characters (Reference 8).
setwd(paste("C:/Users/brownb/Desktop/Udacity/Data Analyst Nanodegree/",
            "Term 2/Exploratory Data Analysis/Project 2", sep = ""))
```

```{r echo=FALSE, Load_the_Data}
# Load the Data (Reference 9)

prosper_df <- read.csv('prosperLoanData.csv')
```

# Univariate Analysis

First, I will perform some univariate analyses, plotting bar charts and 
histograms of various variables of interest to get an idea about how each 
variable is related to measures such as the number of borrowers who default and 
the number who successfully pay back their loans.  Once we have the univariate plots, we can have an idea about what variables we may want to explore in a multi-variate fashion.

```{r echo=FALSE, Univariate_Plots}
# First, I need to see the dimensions and structure of the data as is. This way
# I can get an idea at any transformations I need to perform on the data.

# Obtain the dimensions of the dataframe as is (Reference 10).
dim(prosper_df)

# Obtain the structure of the dataframe as is (Reference 11).
str(prosper_df)
```

  Since there are 81 variables, it is impossible to examine the relationships between all of them.  So I will pick a subset of the variables.  My main 
question is how variables of interest relate to the ability or inability of a borrower to pay back the loan amount plus interest.  Because of this, the most important variable I will be looking at is Loan Status.  This is a categorical variable with categories such as Completed, Defaulted, and Past Due for varying number of days among others.  It would make sense that a person's employment status will affect their ability to pay back the loans so I will also look at 
this variable.  A borrower's credit score is a statistical method to determine 
the likelihood that they will pay back a loan in a specified amount of time (Reference 4), so I will look at that variable and see how it is related to loan status (specifically the lower range of a person's credit score at the time the listing was created).  It would be expected that a borrower with a low debt to income ratio would have an easier time paying back loans, so this variable will 
be considered in this analysis.  
  
  Two variables which are only for listings post July 2009 are Prosper Score and Prosper Rating.  A Prosper Score is a number from 1 to 11 determined by Prosper which represents the probability of a loan going "bad" where bad is defined as 
the loan going 60 or more days past due within 12 months of the loan origination (1 is the highest risk score and 11 is the lowest risk) (Reference 5).  I will 
see how this variable is related to loan status and also to another variable, 
the number of days the loan is delinquent (number of days a payment is past due) (Reference 6).  A Prosper Rating is a grade assigned to a loan to determine the estimated annual loss to potential investors (AA to HR with AA having the lowest estimated loss and HR having the highest) (Reference 7).  It would be expected that in general, loans with the best rating (AA) would have the fewest number of borrowers who default on the loan.  One important point to keep in mind during this project is that a Prosper Rating may not be accurate because it is based on 
a borrower's credit report which may contain inaccurate information (Reference 
7). Another variable that will be examined is whether or not a borrower is a 
home owner.  If a borrower is a home owner, I would expect they will have higher credit worthiness and be less susceptible to going into default.  Finally, I 
will look at Borrower APR.  An APR is an annual charged rate which is the cost 
of borrowing the money (Reference 8).  My guess is that the lower this amount 
is, the easier it will be to pay back the loans.  I will look at this variable 
as well. 

  In summary the independent variables for this project are loan status and 
number of days the current loan is delinquent.  The dependent variables are employment status, credit score range lower, debt to income ratio, prosper 
score, prosper rating, borrower APR and is borrower a homeowner.  Note that for prosper score and prosper rating I will need to subset the data frame to only include dates post July 2009. 

```{r echo=FALSE, subset_dataframe}

# Subset the dataframe to only include the variables I described above

# Create a vector of strings representing the variable names from the prosper
# dataframe I wish to keep (Reference 12).
selected_variables <- c('LoanStatus', 'EmploymentStatus', 'BorrowerAPR',
                        'CreditScoreRangeLower', 'DebtToIncomeRatio',
                        'ProsperScore','ProsperRating..Alpha.',
                        'LoanCurrentDaysDelinquent', 'IsBorrowerHomeowner')


# Create new dataframe with only the variables I wish to keep (Reference 13).
prosp_sub <- subset(prosper_df, select = selected_variables)

# Rename the variables (Reference 14)

prosp_sub <- rename(prosp_sub, loan_status = LoanStatus, 
       employment_status = EmploymentStatus, borrower_apr = BorrowerAPR,
       credit_score_range_lower = CreditScoreRangeLower,
       debt_to_income_ratio = DebtToIncomeRatio, prosper_score = ProsperScore,
       prosper_rating = ProsperRating..Alpha., 
       days_delinquent = LoanCurrentDaysDelinquent, 
       is_homeowner = IsBorrowerHomeowner)
```

```{r, echo=FALSE, loan_status_graph}

# Plotting a bar graph of loan_status; proportions for each category

# After plotting an initial version of the bar graph for loan_status, I 
# realized that there were several variables of Past Due.  I will now combine 
# all these variables into one variable (combine any Past Due amounts to simply 
# be past due). Since I mainly only care about statuses of Defaulted and
# Completed.

# Create a variable which contains all the possible Past Due categories.  
# They will be lumped into one category called "Past Due" (Reference 12)

past_due <- c('Past Due (>120 days)', 'Past Due (1-15 days)', 
              'Past Due (16-30 days)', 'Past Due (31-60 days)', 
              'Past Due (61-90 days)', 'Past Due (91-120 days)')

# First I need to add a factor level to the factor variable loan_status 
# (Reference 15).

prosp_sub$loan_status <- factor(prosp_sub$loan_status, 
                    levels = c(levels(prosp_sub$loan_status), "Past Due"))

# Now for all categories contained in past_due, set them to 'Past Due'
# (Reference 16)

prosp_sub[prosp_sub$loan_status %in% past_due, 1] <- c('Past Due')

# I'm now goint to lump "FinalPaymentInProgress" with Completed since loans
# in this status are basically complete.

# Create variable called complete with all categories that will be made
# to be "Complete" (Reference 12)
complete <- c('Completed', 'FinalPaymentInProgress')

# Now for all categories contained in complete, set them to 'Completed'
# (Reference 16)
prosp_sub[prosp_sub$loan_status %in% complete, 1] <- c('Completed')

# Now get rid of the factors that I don't use. 
# (Reference 15). Note that I ordered the levels from best case scenario
# (Completed) to worst case scenario (ChargedOff).  Loans that are 
# cancelled aren't really good or bad.

prosp_sub$loan_status <- factor(prosp_sub$loan_status, 
                    levels = c("Completed", "Current", "Past Due", 
                               "Defaulted", "Chargedoff", "Cancelled"))

# Get counts for each category

summary(prosp_sub$loan_status)

# Create the bar graph of proportion of borrowers (References 17 and 18)
ggplot(prosp_sub, aes(loan_status)) + 
  geom_bar(aes(y=..count../sum(..count..))) + ylab('Proportion of Borrowers')
```

```{r echo=FALSE, message=FALSE, warning=FALSE, resources}
# Resources - code

# Reference 1: http://ggplot2.org/

# Reference 2: https://yihui.name/knitr/

# Reference 3: https://dplyr.tidyverse.org/

# Reference 4: https://stackoverflow.com/questions/29189663/trying-to-
# publish-an-r-notebook-and-keep-getting-the-same-error-error-in-contri

# Reference 5: http://kbroman.org/knitr_knutshell/pages/Rmarkdown.html

# Reference 6: https://stackoverflow.com/questions/5595512/what-is-the-
# difference-between-require-and-library

# Reference 7: http://rfunction.com/archives/1001

# Reference 8: https://stackoverflow.com/questions/6329962/split-code-over-
# multiple-lines-in-an-r-script

# Reference 9: http://rprogramming.net/read-csv-in-r/

# Reference 10: https://stat.ethz.ch/R-manual/R-devel/library/base/html/dim.html

# Reference 11: https://www.rdocumentation.org/packages/utils/versions/3.4.3/
# topics/str

# Reference 12: https://stackoverflow.com/questions/11488820/why-use-c-to-
# define-vector

# Reference 13: https://www.rdocumentation.org/packages/base/versions/3.5.0/
# topics/subset

# Reference 14: http://www.sthda.com/english/wiki/renaming-data-frame-columns-
# in-r

# Reference 15: https://stats.idre.ucla.edu/r/modules/factor-variables/

# Reference 16: https://stackoverflow.com/questions/32845303/using-logical-
# operators-with-characters

# Reference 17: https://stackoverflow.com/questions/36604127/creating-a-bar-
# plot-with-proportions-on-ggplot

# Reference 18: http://ggplot2.tidyverse.org/reference/geom_bar.html


# NOTE: This is the Resources list only for the code chuncks.  I am placing this list inside of this chunck so that they do not appear when knitting the HTML 
# file (for users who want to do that at the end). The only resources I want to appear when knitting the HTML file are those referenced inside the file and 
# meant to be visible (outside the R chuncks).
```

# Resources

Reference 1: https://www.prosper.com/home/about

Reference 2: https://www.kaggle.com/jschnessl/prosperloans/feed

Reference 3: https://docs.google.com/spreadsheets/d/1gDyi_L4UvIrLTEC6Wri5nbaMmkGmLQBk-Yx3z0XDEtI/edit#gid=0

Reference 4: https://www.investopedia.com/articles/00/091800.asp

Reference 5: https://www.prosper.com/plp/general-prosper_score/

Reference 6: https://www.investopedia.com/terms/d/delinquent.asp

Reference 7: https://www.prosper.com/Downloads/Legal/Prosper_Prospectus_2018-04-30.pdf

Reference 8: https://www.investopedia.com/terms/a/apr.asp