Prosper Loan Exploratory Data Analysis by Brandon Brown
========================================================

> Prosper is a peer-to-peer lending marketplace in the United States which 
provides a platform for borrowers and lenders (Reference 1). Borrowers can 
apply for a fixed-rate, fixed-term loan of between $2,000 and $35,000 and individuals/institutions can invest in loans which generate attractive returns (Reference 1). Data is available on Prosper loans (Reference 2). This data 
includes interest rates, borrower employment status, borrower income, loan 
amount, borrower credit history and many other variables (Reference 3). The 
purpose of this project is to explore the data to determine which conditions 
might be associated with whether a borrower will be successful in paying back 
the original loan amount and interest. I expect to see which borrower employment status, credit score, debt to income ratio and other loan variables are most associated with those who default on their loans and who successfully complete 
their loan payments.

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Loading all of the packages I will use in this project. I will be using 
# ggplot2 to construct plots (Reference 1), knitr to put the R markdown document into an HTML document (Reference 2) and dplyr to mutate and transform the data (Reference 3).  I had to add a repos section to get the knitting of the html 
# file to complete (Reference 4).  

# NOTE ABOUT REFERENCES: At the end of this RMD file I have two Resources 
# sections.  The first is inside of an R chunk and is only for code inside R chunks.  The second is outside the R chunk and is only for analyses and 
# paragraphs outside the R chunks.  I did this so that references for code 
# inside the R chunks wouldn't be visible in a knitted HTML file if users 
# want to knit together the file (because the R chunks themselves won't be visible). 


install.packages("ggplot2", dependencies = T, 
                 repos = "http://cran.us.r-project.org") 
install.packages("knitr", dependencies = T, 
                 repos = "http://cran.us.r-project.org")
install.packages("dplyr", dependencies = T, 
                 repos = "http://cran.us.r-project.org")

# Installing GGally package so that I can graph pairs of variables against
# each other in a matrix fashion (Reference 25)
install.packages("GGally", dependencies = T, 
                 repos = "http://cran.us.r-project.org")

# I set echo, message and warning to all be false so that I wouldn't see the 
# code in the HTML document or any warning messages (Reference 5)

# Load the libraries using the library function.  Note that you can use ? in 
# front of any command I use to see what the command does.  This tells what the command does (Reference 6).

library(ggplot2)
library(knitr)
library(dplyr)
library(GGally)

# Get and set working directory (Reference 7)
# NOTE: For users wishing to contribute, you will need to set the path to that 
# you have cloned the project to inside the parentheses in setwd.
getwd()

# I used the paste function because my file name was too long and I needed
# to shorten it to below 80 characters (Reference 8).
setwd(paste("C:/Users/brownb/Desktop/Udacity/Data Analyst Nanodegree/",
            "Term 2/Exploratory Data Analysis/Project 2", sep = ""))
```

```{r echo=FALSE, message=FALSE, warning=FALSE, Load_the_Data}
# Load the Data (Reference 9)

prosper_df <- read.csv('prosperLoanData.csv')
```

# Univariate Analysis

First, I will perform some univariate analyses, plotting bar charts and 
histograms of various variables of interest to get an idea about how each 
variable is related to measures such as the number of borrowers who default and 
the number who successfully pay back their loans.  Once we have the univariate plots, we can have an idea about what variables we may want to explore in a multi-variate fashion.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
# First, I need to see the dimensions and structure of the data as is. This way
# I can get an idea at any transformations I need to perform on the data.

# Obtain the dimensions of the dataframe as is (Reference 10).
dim(prosper_df)

# Obtain the structure of the dataframe as is (Reference 11).
str(prosper_df)
```

  Since there are 81 variables, it is impossible to examine the relationships between all of them.  So I will pick a subset of the variables.  My main 
question is how variables of interest relate to the ability or inability of a borrower to pay back the loan amount plus interest.  Because of this, the most important variable I will be looking at is Loan Status.  This is a categorical variable with categories such as Completed, Defaulted, and Past Due for varying number of days among others.  It would make sense that a person's employment 
status will affect their ability to pay back the loans so I will also look at 
this variable.  A borrower's employment duration probably correlates with their ability to keep their job, which would make it easier to pay back the loans so I will look at this variable as well.  I will also look at the income range for borrowers since having a higher income would probably make it easier to pay back loans.  A borrower's credit score is a statistical method to determine 
the likelihood that they will pay back a loan in a specified amount of time (Reference 4), so I will look at that variable and see how it is related to loan status (specifically the lower range of a person's credit score at the time the listing was created).  It would be expected that a borrower with a low debt to income ratio would have an easier time paying back loans, so this variable will 
be considered in this analysis.  
  
  Two variables which are only for listings post July 2009 are Prosper Score and Prosper Rating.  A Prosper Score is a number from 1 to 11 determined by Prosper which represents the probability of a loan going "bad" where bad is defined as 
the loan going 60 or more days past due within 12 months of the loan origination 
(1 is the highest risk score and 11 is the lowest risk) (Reference 5).  I will 
see how this variable is related to loan status and also to another variable, 
the number of days the loan is delinquent (number of days a payment is past due) (Reference 6).  A Prosper Rating is a grade assigned to a loan to determine the estimated annual loss to potential investors (AA to HR with AA having the lowest estimated loss and HR having the highest) (Reference 7).  It would be expected 
that in general, loans with the best rating (AA) would have the fewest number of borrowers who default on the loan.  One important point to keep in mind during 
this project is that a Prosper Rating may not be accurate because it is based on 
a borrower's credit report which may contain inaccurate information (Reference 
7). Another variable that will be examined is whether or not a borrower is a 
home owner.  If a borrower is a home owner, I would expect they will have higher credit worthiness and be less susceptible to going into default.  Finally, I 
will look at Borrower APR.  An APR is an annual charged rate which is the cost 
of borrowing the money (Reference 8).  My guess is that the lower this amount 
is, the easier it will be to pay back the loans.  I will look at this variable 
as well. 

  In summary the dependent variables for this project are loan status and 
number of days the current loan is delinquent.  The independent variables are employment status, employment duration, income range, credit score range lower, debt to income ratio, prosper score, prosper rating, borrower APR and is 
borrower a homeowner.  Note that for prosper score and prosper rating I will 
need to subset the data frame to only include loans which actually have a score and rating (those post July 2009).  Note also that for income range, I will
subset and only consider data for which the income is verifiable (I have
included this variable as well in the data I will use) and for employment 
duration (employment status duration), I will not consider statuses of no 
listing (a blank status), not available, retired and other.  I will set the employment duration of those who are unemployed as 0. 

```{r echo=FALSE, message=FALSE, warning=FALSE, subset_dataframe}

# Subset the dataframe to only include the variables I described above

# Create a vector of strings representing the variable names from the prosper
# dataframe I wish to keep (Reference 12).
selected_variables <- c('LoanStatus', 'EmploymentStatus',  
                        'EmploymentStatusDuration', 'IncomeRange', 
                        'IncomeVerifiable', 'BorrowerAPR',
                        'CreditScoreRangeLower', 'DebtToIncomeRatio',
                        'ProsperScore','ProsperRating..Alpha.',
                        'LoanCurrentDaysDelinquent', 'IsBorrowerHomeowner')


# Create new dataframe with only the variables I wish to keep (Reference 13).
prosp_sub <- subset(prosper_df, select = selected_variables)

# Rename the variables (Reference 14)

prosp_sub <- rename(prosp_sub, loan_status = LoanStatus, 
                               employment_status = EmploymentStatus,                                      employment_status_duration = EmploymentStatusDuration,
                               income_range = IncomeRange,
                               income_verifiable = IncomeVerifiable,
                               borrower_apr = BorrowerAPR,      
                         credit_score_range_lower = CreditScoreRangeLower,
                               debt_to_income_ratio = DebtToIncomeRatio, 
                               prosper_score = ProsperScore,
                               prosper_rating = ProsperRating..Alpha., 
                               days_delinquent = LoanCurrentDaysDelinquent, 
                               is_homeowner = IsBorrowerHomeowner)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, loan_status_graph}

# Plotting a bar graph of loan_status; proportions for each category

# After plotting an initial version of the bar graph for loan_status, I 
# realized that there were several variables of Past Due.  I will now combine 
# all these variables into one variable (combine any Past Due amounts to simply 
# be past due). Since I mainly only care about statuses of Defaulted and
# Completed.

# Create a variable which contains all the possible Past Due categories.  
# They will be lumped into one category called "Past Due" (Reference 12)

past_due <- c('Past Due (>120 days)', 'Past Due (1-15 days)', 
              'Past Due (16-30 days)', 'Past Due (31-60 days)', 
              'Past Due (61-90 days)', 'Past Due (91-120 days)')

# First I need to add a factor level to the factor variable loan_status 
# (Reference 15).

prosp_sub$loan_status <- factor(prosp_sub$loan_status, 
                    levels = c(levels(prosp_sub$loan_status), "Past Due"))

# Now for all categories contained in past_due, set them to 'Past Due'
# (Reference 16)

prosp_sub[prosp_sub$loan_status %in% past_due, 'loan_status'] <- c('Past Due')

# I'm now goint to lump "FinalPaymentInProgress" with Completed since loans
# in this status are basically complete.

# Create variable called complete with all categories that will be made
# to be "Complete" (Reference 12)
complete <- c('Completed', 'FinalPaymentInProgress')

# Now for all categories contained in complete, set them to 'Completed'
# (Reference 16)
prosp_sub[prosp_sub$loan_status %in% complete, 'loan_status'] <- c('Completed')

# Now get rid of the factors that I don't use. 
# (Reference 15). Note that I ordered the levels from best case scenario
# (Completed) to worst case scenario (ChargedOff).  Loans that are 
# cancelled aren't really good or bad.

prosp_sub$loan_status <- factor(prosp_sub$loan_status, 
                    levels = c("Completed", "Current", "Past Due", 
                               "Defaulted", "Chargedoff", "Cancelled"))

# Get counts for each category

summary(prosp_sub$loan_status)

# Create the bar graph of proportion of borrowers (References 17 and 18)
ggplot(prosp_sub, aes(loan_status)) + 
  geom_bar(aes(y=..count../sum(..count..))) + ylab('Proportion of Borrowers')
```

From this plot, the category with the highest proportion of borrowers is clearly
the Current loans.  I lumped all the Past Due categories into one Past Due 
category since I only really care about Completed, Defaulted and Chargedoff
loans.  I also lumped the FinalPaymentInProgress category into the Completed
category since these loans are for all intents and purposes finished.  I did
some research and Chargedoff loans are Defaulted loans for which there is no
expectation of re-payment by the lenders (Reference 9).  Because of this, I am equally as interested in Chargedoff loans as I am those in Default. Completed 
loans clearly have a better proportion than the combination of Defaulted and Chargedoff loans (around 0.37 versus around 0.15).  It will be interesting to 
see how these proportions match up with those of employment status, credit score and the other variables.

```{r, echo=FALSE, message=FALSE, warning=FALSE, employment_status_graph}
# Plotting bar graph of proportions of borrowers with each employment status

# After graphing the initial version of the bar graph, I realize I need to 
# rotate the axis labels to be able to keep them from running into each other.
# (Reference 19).  I also graph the proportions as I did with loan status.


ggplot(prosp_sub, aes(employment_status)) + 
  geom_bar(aes(y=..count../sum(..count..))) + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
  ylab('Proportion of Borrowers')

# Get counts for each category
summary(prosp_sub$employment_status)

```

From the data available we can conclude that the information given isn't very helpful at possibly predicting whether a borrower will be successful in paying 
back their loans.  This is primarily because the categories are vague.  The 
highest proportion of borrowers fit into the "Employment" category.  This 
category is very vague.  It doesn't indicate whether the borrower is a Full-time or Part-time employee (there are actually categories for this).  It also doesn't indicate what their salary is.  There are also the categories of Other and a portion of the borrowers who did not list an employment status.  If I were to decide to examine this data further in the bivariate and multivariate portions 
of the analysis, I might get rid of the borrowers fitting in the Other and non-labeled categories.  I may construct a plot or two to see if there are relationships, but I think other variables I've chosen to focus on will give a better indication of success.  I picked this variable just to see if there may actually be an obvious pointer to a relationship but there isn't (for an obvious pointer to a relationship to exist, the proportions of one category would need 
to equal that of the Completed and Default/ChargedOff categories).  Even if the proportions were equal, the relationship may not be straight-forward between 
these two variables.

```{r, echo=FALSE, message=FALSE, warning=FALSE, income_range}
# Plotting bar graph of proportions of borrowers with each level of income.
# I am only considering the data for which the income is verifiable


# After graphing an initial plot and looking at the summary, I realize two
# things.  The first is that there are two categories, not employed and
# an income of 0$ which I will lump together.  The second is that there is a
# category for "Not displayed".  I will not consider this data either in
# the graph.

# Set the categories to be lumped together equal to a variable called zero
# (Reference 12)
zero <- c('$0', 'Not employed')

# Now for all categories contained in zero, set them to '$0'
# (Reference 16)
prosp_sub[prosp_sub$income_range %in% zero, 'income_range'] <- c('$0')

# Now get rid of the factors that I don't use. 
# (Reference 15). Note that I ordered the levels from lowest income to 
# highest income.

prosp_sub$income_range <- factor(prosp_sub$income_range, 
                    levels = c("$0", "$1-24,999", "$25,000-49,999", 
                               "$50,000-74,999", "$75,000-99,999",
                               "$100,000+"))

# Plot the bar chart of income range only including income that is verifiable
# and not including income ranges for which we have NA (note that this used
# to be not displayed) (References 17 and 18)
ggplot(subset(prosp_sub, income_verifiable == 'True' &
                income_range != 'NA'), aes(income_range)) +
                geom_bar(aes(y=..count../sum(..count..))) + 
                ylab('Proportion of Borrowers')

# Get counts for each category

summary(subset(prosp_sub, income_verifiable == 'True' & 
                 income_range != 'NA')$income_range)
```

From the above bar chart of proportion of borrowers inside each income range
I considered, the largest proportions are for $25,000-49,999 and $50,000-74,999.
The proportion was about the same for the higher two categories.  Note that
I did not consider data which was not verifiable.  I also lumped two categories
together, borrowers which had an income of $0 and borrowers which had an 
income of 'Not employed'.  It's hard to say which of these categories may be
associated with higher levels of success or failure in paying back the loans.
It would be assumed that the higher a borrower's income, the easier it will be
for them to pay back a loan but this isn't the only variable affecting success
or failure so I will need to further look at this in the bi-variate and multi-
variate case.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height = 8, fig.width = 8,   employment_status_duration}
# This chunk generates three versions of the histogram of employment status duration.  I initially generate a basic histogram but then adjust it, zooming in 
# on the data and adjusting the binwidth. For the second graph, I also used a
# log transform of the data to try and correct for a right skew in the initial histogram.  I then graph all three of them on one grid.

# First I've got to place conditions on what data I will consider and I've got
# to set all durations for those not employed to be 0 (Reference 26)

prosp_sub$employment_status_duration <- ifelse(prosp_sub$employment_status ==
                                                 'Not employed',
                                        0*prosp_sub$employment_status_duration,
                                        prosp_sub$employment_status_duration)

# Now, set employment condition
condition <- c("Employed", "Full-time", "Not employed", "Self-employed",
               "Part-time")


# Plot the initial distribution of employment status duration (Reference 20)

q1 <- ggplot(subset(prosp_sub, employment_status %in% condition),
             aes(employment_status_duration)) + geom_histogram() 

# Plot histogram while taking log10 of employment status duration
# (Reference 27).  I also zoom in on the newly transformed data.  Note that I 
# added 1 so that I could find the log10 of durations which are 0.  I pick a max of 3 so that I can see all the data (Reference 21). I used coord_cartesian so 
# that I wouldn't shave off any data.

q2 <- ggplot(subset(prosp_sub, employment_status %in% condition),
             aes(log10(employment_status_duration+1))) + 
             geom_histogram(binwidth=0.1) + coord_cartesian(xlim = c(0,3))

# Plot histogram while zooming in to the range of most of the data and picking 
# a better binwidth (Reference 20). Note again that I've decided not to 
# transform the data using log10 after seeing the middle graph. 

q3 <- ggplot(subset(prosp_sub, employment_status %in% condition),
             aes(employment_status_duration)) + 
             geom_histogram(binwidth=1) + coord_cartesian(xlim = c(0,400))

# Read in grid extra to plot all these histograms on the same graph 
# (Reference 22)
library(gridExtra)

grid.arrange(q1, q2, q3, ncol = 1)

# Get summary of employment status duration

summary(subset(prosp_sub, employment_status %in%
                 condition)$employment_status_duration)
```

Based on the second and third graphs, the data is definitely right-skewed. 
This data represents employment status duration, but because of how I have
set the number of months worked for those unemployed to be 0, I am basically
considering employment duration.  I did this in part because there were
outliers for those not employed of multiple years.  I cannot see Prosper letting a borrower have a loan who had not been employed for many years (I originally 
let the employment status duration for those not employed to be negative).  
There are still outliers in the data here.  From the summary, the maximum
number of months worked is 745 or around 63 years.  This may actually be 
possible, but if I graph this data against loan status or any other variable
in the bi-variate or multi-variate portions of this project, I will cut off
this data from consideration.  In the next R chunk, I will see what this data
looks like for anything above 400 months (33 years).  After transforming the
data using log10, the data is still left-skewed.  Because of this, I may not
transform the data in the bi-variate or multi-variate case.  My guess is that
the larger ones' employment duration, the more likely they are to pay back 
loans.

```{r, echo=FALSE, message=FALSE, warning=FALSE, employment_status_duration400}

# See the first 6 rows of data for those with employment status duration 
# greater than 400 (Reference 23).
head(subset(subset(prosp_sub, employment_status %in%
                 condition), employment_status_duration > 400))

```

After looking at the data for durations above 400 months (and for the specific
case of 743 months, not shown), I actually do think this data is possible and
that the information wasn't miss-entered.  Because of this, I will keep this
data when performing calculations in the bi-variate and multi-variate case.

```{r, echo=FALSE,  message=FALSE, warning=FALSE, fig.height = 8, fig.width = 8, credit_score_range_lower}
# This chunk generates three versions of the histogram of lower range of credit scores.  I initially generate a basic histogram but then adjust it, zooming in 
# on the data and adjusting the binwidth.  I then graph all three of them on
# one grid.


# Plot the initial distribution of lower ranges of credit scores (Reference 20)


q1 <- ggplot(prosp_sub, aes(credit_score_range_lower)) + 
             geom_histogram() 

# Plot histogram while zooming in to the range of most of the data. I pick a max 
# of 880 because this value is the maximum given in the summary below (Reference 21). I used coord_cartesian so that I wouldn't shave off any data.

q2 <- ggplot(prosp_sub, aes(credit_score_range_lower)) + 
        geom_histogram() + coord_cartesian(xlim = c(375,880))

# Plot histogram while zooming in to the range of most of the data and picking a better binwidth (Reference 20)

q3 <- ggplot(prosp_sub, aes(credit_score_range_lower)) + 
       geom_histogram(binwidth = 1) + coord_cartesian(xlim = c(375,880))

# Read in grid extra to plot all these histograms on the same graph 
# (Reference 22)

grid.arrange(q1, q2, q3, ncol = 1)

# Get summary of the low range of credit score

summary(prosp_sub$credit_score_range_lower)
```

From the three plots of the histograms, each more finely tuned than the next, 
I notice a few things.  The first is that there are some borrowers with a credit
score of zero.  I am going to see what the rest of the variables looks like
for some of these borrowers to see if I should discard them or if I should
keep them (if it was simply an error in entering the data).  The next is that
the data is pretty close to being normal.  From the summary given, the mean
is only 5.6 away from the median out of a range of 40 for the IQR.  Since
the mean is greater than the median however, it is skewed to the right.  I 
don't think it's enough to warrant performing a transformation on the data,
however.  The middle plot was bi-modal but changing the binwidth caused this
to disappear from the data. Another thing I noticed after changing the binwidth 
is that there appears to be only integer values of credit score in increments of 20. There do not appear to be values that aren't whole or that fall between 
values of 600, 620, 640 and so on (note that I confirmed this using the table command but didn't include it in the final code). In terms of lower range of 
credit score predicting the ability of a borrower to pay back their loans, there is a fairly steep drop off from around 640 to 620 in the number of borrowers.  
I would be interested to see what percentage of the borrowers to the left of the drop off are in each of the loan status categories.  I may look at how this 
variable changes with each loan status category using a box plot in the 
bi-variate analysis.

```{r, echo=FALSE, message=FALSE, warning=FALSE, credit_score_range_lower0}

# See the first 6 rows of data for those with lower range of credit score of
# 0 (Reference 21)
head(subset(prosp_sub, credit_score_range_lower == 0))

```

Looking at the first 6 rows of data for those with a lower credit score range of 0, I actually think the data is good and that is truly the lower range on the credit score.  The employment status and debt to income ratio is unknown for the first six rows of data, so these rows are probably cases where very little information is known about the borrowers so the risk for investors will be high.  The APR seems to be high for the first 6 rows of data so that would make sense 
for borrowers with bad credit scores.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height = 8, fig.width = 8, debt_to_income_ratio}
# This chunk generates three versions of the histogram of debt to income ratio.  
# I initially generate a basic histogram but then adjust it, zooming in 
# on the data and adjusting the binwidth.  I then graph all three of them on
# one grid.


# Plot the initial distribution of debt to income ratios (Reference 20)


q1 <- ggplot(prosp_sub, aes(debt_to_income_ratio)) + 
             geom_histogram() 

# Plot histogram while zooming in to the range of most of the data. I pick a max 
# of 1 since this seems to be where most of the data is (Reference 21). I used coord_cartesian so that I wouldn't shave off any data.

q2 <- ggplot(prosp_sub, aes(debt_to_income_ratio)) + 
        geom_histogram(binwidth = 0.1) + coord_cartesian(xlim = c(0,1))

# Plot histogram while zooming in to the range of most of the data and picking a better binwidth (Reference 20)

q3 <- ggplot(prosp_sub, aes(debt_to_income_ratio)) + 
       geom_histogram(binwidth = 0.005) + coord_cartesian(xlim = c(0,1))

# Plot all these histograms on the same graph (Reference 22)

grid.arrange(q1, q2, q3, ncol = 1)

# Get summary of the debt to income ratio

summary(prosp_sub$debt_to_income_ratio)
```

A few things stand out about these graphs.  The first is that there appears that there might be outliers close to a ratio of 10.  Again, I will check these out 
in the next R chunk to see if I should drop the data.  The second is that like 
the credit score graph, the data is skewed to the right.  This initially 
surprised me but it didn't after thinking on it some more.  I was initially thinking that the higher a borrower's debt to income ratio is, the less able 
they will be to pay back their loans.  But it actually may be that borrowers 
with higher incomes are able to take on much more debt and still be successful 
at paying back the loans (my guess is that there is a lot of overlap between the two graphs).  A significant portion of the debt for those with higher debt to income ratios is probably student loan debt.  It could very well be that 
borrowers with low debt to income ratios simply don't have the ability to take 
out loans because their income is low and because of this, they are the ones who will be less successful at paying back loans. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, debt_to_income_ratio5}

# See the first 6 rows of data for those with debt to income ratio greater than
# 5 (Reference 23)
head(subset(prosp_sub, debt_to_income_ratio >= 5))
```

After looking at the first few rows for borrowers with a debt to income ratio
greater than 5, I now think that this data should be left.  One of the reasons
borrowers may have an extremely high debt to income ratio is because they have
either lost their jobs but have fairly good credit scores or because they are
simply between jobs.  This would cause an extremely low income which would
explain the high debt to income ratios.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height = 8, fig.width = 8, borrower_apr}
# This chunk generates three versions of the histogram of borrower apr.  I initially generate a basic histogram but then adjust it, zooming in 
# on the data and adjusting the binwidth.  I then graph all three of them on
# one grid.


# Plot the initial distribution of borrower apr (Reference 20)


q1 <- ggplot(prosp_sub, aes(borrower_apr)) + 
             geom_histogram() 

# Plot histogram while zooming in to the range of most of the data. I pick a 
# max of 0.4 since this seems to be where most of the data is (Reference 21). I used coord_cartesian so that I wouldn't shave off any data.

q2 <- ggplot(prosp_sub, aes(borrower_apr)) + 
        geom_histogram() + coord_cartesian(xlim = c(0,0.4))

# Plot histogram while zooming in to the range of most of the data and picking a better binwidth (Reference 20)

q3 <- ggplot(prosp_sub, aes(borrower_apr)) + 
       geom_histogram(binwidth = 0.0005) + coord_cartesian(xlim = c(0,0.4))

# Plot all these histograms on the same graph (Reference 22)

grid.arrange(q1, q2, q3, ncol = 1)

# Get summary of the borrower_apr

summary(prosp_sub$borrower_apr)
```

The first thing to notice about this graph is that from the summary and the 
first two plots, the data appears to be skewed to the right.  This is confusing
to me because I was assumming that borrowers with good credit scores would
have lower APR's.  I was assuming that this graph would be skewed to the
left and be a reflection of the credit score and debt to income ratio
histograms.  A few things could be responsible for this result.  The first
is that there may not be a nice relationship between good credit score and 
borrower apr.  Perhaps a borrower has a good credit score but they have lost
their job which makes them a risky investment.  Or at the other end of the 
spectrum, perhaps a borrower has a bad credit history but has landed a good job such that prosper assigns a lower than expected interest rate.  And it is not 
even certain that there is a nice relationship between credit score and debt to income ratio as I guessed earlier.  I will have to graph these variables against each other to determine a discernible relationship.  Another observation 
pointing to the possibility that there may not be a nice relationship between borrower apr and credit score/debt to income ratio is that the mode on the 
borrower apr is significantly different from the mean and median.  From the 
third plot with a fine binwidth, the mode appears to be around 0.36 while the median and mean is around 0.21.  One final observation is that there are 
borrowers with apr's greater than 0.4.  I'm going to assume that these data 
points are accurate and are not outliers which have been incorrectly entered 
since I accepted the data I thought were outliers for debt to income ratio and credit score.  

```{r, echo=FALSE, message=FALSE, warning=FALSE,fig.height = 8, fig.width = 8, days_delinquent}
# This chunk generates three versions of the histogram of days delinquent.  I initially generate a basic histogram but then adjust it, zooming in 
# on the data and adjusting the binwidth.  I then graph all three of them on
# one grid.  Note that I only considered borrowers for which there was actually
# a days delinquent value (non-zero) and for which the loan had not been put in
# defaulted or charged off status.

# Create condition that the number of days delinquent must be greater than 0 
# and that the loan status must not be defaulted or charged off.
condition <- ((prosp_sub$days_delinquent > 0) & 
                (prosp_sub$loan_status != 'Defaulted') & 
                (prosp_sub$loan_status != 'Chargedoff'))

# Plot the initial distribution of days delinquent (Reference 20)

q1 <- ggplot(subset(prosp_sub, condition), aes(days_delinquent)) + 
             geom_histogram() 

# Plot histogram while zooming in to the range of most of the data. I pick a max 
# of 129 since this was the maximum number of days based on the summary below (Reference 21). I used coord_cartesian so that I wouldn't shave off any data.

q2 <- ggplot(subset(prosp_sub, condition), aes(days_delinquent)) + 
        geom_histogram() + coord_cartesian(xlim = c(0,129))

# Plot histogram while zooming in to the data and picking a better binwidth (Reference 20)

q3 <- ggplot(subset(prosp_sub, condition), aes(days_delinquent)) + 
       geom_histogram(binwidth = 1) + coord_cartesian(xlim = c(0,129))

# Plot all these histograms on the same graph (Reference 22)

grid.arrange(q1, q2, q3, ncol = 1)

# Get summary of the days_delinquent variable under the laid out conditions.

summary(subset(prosp_sub, condition)$days_delinquent)
```

For the days_delinquent variable, I only considered loans that had not been
charged off or defaulted since they are in a separate category and will have
large values.  I also only considered cases for which there was a non-zero value
for days_delinquent.  Had I considered all the borrowers, a disproportionally 
large number of them would have been zero days' delinquent and I wouldn't be 
able to gain any insights on borrowers who hadn't yet defaulted or been charged
off on their loans who also are delinquent in paying their loans.  From these
distributions, the data is definitely skewed to the right with the median at 27 
days.  Most of the cases are below 50 days.  It's hard to know which variables
may predict the number of days' delinquent since thus far I have considered all
the data and not subsetted the data as I did in this R chunk.  It may also be
good in the future to consider the ratio of days' delinquent to number of days 
since the loan originated.  This might be a better indicator of the relative
success of borrowers paying back their loans.  A borrower may be 30 days'
delinquent but only 2 months into paying back the loans while another borrower 
may be 30 days' delinquent but be halfway through paying back the loans (a 
matter of years).  The delinquency for the second borrower isn't going to be 
viewed in the same way as that of the first.  This variable is a secondary independent variable to that of loan status so I'm not as concerned at gaining insights into what may predict these numbers.

```{r, echo=FALSE, message=FALSE, warning=FALSE, is_homeowner}
# Plotting bar graph of proportions of borrowers that are and are not homeowners
# (References 17 and 18)

ggplot(prosp_sub, aes(is_homeowner)) + 
  geom_bar(aes(y=..count../sum(..count..))) + 
  ylab('Proportion of Borrowers')

# Get counts for each category

summary(prosp_sub$is_homeowner)
```

From the bar chart above showing proportions of borrowers who own a home, we 
can see that there is minimal difference between the conditions.  The proportion
of borrowers who own a home is slightly greater than 50%.  It's hard to
determine how well this variable predicts loan payback success rate without
using bi-variate and multi-variate graphic capabilities in R.  I will facet loan status over each of these conditions to see which condition has a higher level 
of success and failure.  It would make sense that borrowers owning a home will 
be more likely to payback their loans than those that do not own a home. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, subset_date}
# This R chunk subsets the prosper data such that only data after July 2009
# is considered.  This data will actually have a prosper score and rating.

# Several of the loans had NA for prosper scores.  These loans originated
# in or prior to July 2009.  By subsetting the data to get rid of rows for 
# which the prosper score is NA, I am effectively only considering loans 
# which originated after July 2009 (References 13 and 24).

prosp_2009 <- subset(prosp_sub, !is.na(prosper_score))
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, prosp_2009_combine}
# This R chunk combines some of the prosper scores into one category so that
# I am not considering 11 categories which seem to be a bit too much.

# Create a variable which contains all the possible prosper score low
# categories.  They will be lumped into one category called '1-3'  
# (Reference 12). Also create a variable which contains all the possible 
# prosper score high categories, they will be lumped into one category called
# '9-11'.

prosper_score_low <- c('1', '2', '3')
prosper_score_high <- c('9', '10', '11')

# First I need to turn the variable prosper_score into a factor variable. I 
# will do this in both the prosp_sub and prosp_2009 dataframes (Reference 15).

prosp_sub$prosper_score <- factor(prosp_sub$prosper_score)
prosp_2009$prosper_score <- factor(prosp_2009$prosper_score)

# Now I need to add two factor levels to the factor variable prosper_score (Reference 15). I will do this for both prosp_2009 and prosp_sub.

prosp_sub$prosper_score <- factor(prosp_sub$prosper_score, 
                    levels = c(levels(prosp_sub$prosper_score), "1-3", "9-11"))

prosp_2009$prosper_score <- factor(prosp_2009$prosper_score, 
                    levels = c(levels(prosp_2009$prosper_score), "1-3", "9-11"))

# Now for all categories contained in prosper_score_low and prosper_score_high
# set them to '1-3' and '9-11', respectively (Reference 16).

prosp_sub[prosp_sub$prosper_score %in% prosper_score_low, 
          'prosper_score'] <- c("1-3")

prosp_2009[prosp_2009$prosper_score %in% prosper_score_low, 
           'prosper_score'] <- c("1-3")

prosp_sub[prosp_sub$prosper_score %in% prosper_score_high, 
          'prosper_score'] <- c("9-11")

prosp_2009[prosp_2009$prosper_score %in% prosper_score_high, 
           'prosper_score'] <- c("9-11")

# Now get rid of the factors that I don't use. 
# (Reference 15). Note that I ordered the levels from highest risk (1-3) to
# lowest risk (9-11).

prosp_sub$prosper_score <- factor(prosp_sub$prosper_score, 
                    levels = c("1-3", "4", "5", "6", "7", "8", "9-11")) 

prosp_2009$prosper_score <- factor(prosp_2009$prosper_score, 
                    levels = c("1-3", "4", "5", "6", "7", "8", "9-11")) 
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, prosper_score_graph}
# This R chunk creates a bar graph of proportions of each borrowers
# with the prosper score levels I created in the previous R chunk

# Create the bar graph of proportion of borrowers (References 17 and 18)
ggplot(prosp_2009, aes(prosper_score)) + 
  geom_bar(aes(y=..count../sum(..count..))) + ylab('Proportion of Borrowers')

# Get counts for each category

summary(prosp_2009$prosper_score)
```

Based on the bar chart shown, the combinations of prosper scores 1-3 have the
largest proportion of borrowers while the combinations of prosper scores 9-11
have the second largest proportion of borrowers.  I decided to combine the 
totals for 1-3 and 9-11 into one category so that I wouldn't be considering 11
different categories which seemed to be too much.  It should be noted that
scores of 4 and 6 would have had the highest proportions if I hadn't done this.
This would be reasonable since most users will have around an average risk
associated with the investment (prosper scores of 1 and 11 would have had the lowest and second lowest proportions, respectively).  In terms of prosper scores predicting whether a loan will be defaulted, chargedoff or completed, it is hard to tell.  It is worth mentioning that around the same proportion of borrowers 
assigned a rating between 9-11 also either defaulted or were chargedoff with 
their loans based on the loan status graph previously, but that data considered
all loans and not just those after July 2009 (the bar chart above is only for
data post July-2009).  I will need to use R's bi-variate graphing capabilities 
to see if a relationship exists, I suspect it will. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, prosper_rating_graph}
# This R chunk creates a bar graph of proportions of each borrowers
# with the possible prosper rating levels

# Change order of levels such that they go from highest risk (worst, HR) to 
# lowest risk (best, AA) (Reference 15)
prosp_sub$prosper_rating <- factor(prosp_sub$prosper_rating, 
                    levels = c("HR", "E", "D", "C", "B", "A", "AA")) 

prosp_2009$prosper_rating <- factor(prosp_2009$prosper_rating, 
                    levels = c("HR", "E", "D", "C", "B", "A", "AA")) 

# Create the bar graph of proportion of borrowers (References 17 and 18)
ggplot(prosp_2009, aes(prosper_rating)) + 
  geom_bar(aes(y=..count../sum(..count..))) + ylab('Proportion of Borrowers')

# Get counts for each category

summary(prosp_2009$prosper_rating)
```

From the above bar chart, it appears that the prosper rating with the highest
proportion of borrowers is that with a rating of C.  As with the prosper scores,
this is reasonable since this is the average prosper rating.  Most borrowers
will not have excellent or bad credit but have average credit.  The two ratings
with the lowest and second lowest proportion of borrowers are the AA and HR
ratings, respectively.  As I mentioned with the prosper score, I will need to
use R's bi-variate graphing capabilities to determine the relationship between
prosper score and loan status. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, loan_status_comparison}
# Plotting two bar graphs of loan_status; one for the best possible combination
# of prosper rating and prosper score (AA, 9-11).  The other for the worst
# possible combination (HR, 1-3).  This is to see if there may be a relationship
# between these three variables.

# Set conditions
best_combo <- (prosp_2009$prosper_score == "9-11" & 
                 prosp_2009$prosper_rating == "AA")
worst_combo <- (prosp_2009$prosper_score == "1-3" & 
                  prosp_2009$prosper_rating == "HR")

# Create the bar graph of proportion of borrowers for best possible combination (References 17 and 18)

q1 <- ggplot(subset(prosp_2009, best_combo), aes(loan_status)) + 
  geom_bar(aes(y=..count../sum(..count..))) + ylab('Proportion of Borrowers')

q2 <- ggplot(subset(prosp_2009, worst_combo), aes(loan_status)) + 
  geom_bar(aes(y=..count../sum(..count..))) + ylab('Proportion of Borrowers')

# Plot the charts on a grid (Reference 22)
grid.arrange(q1, q2, ncol = 1)
```

The first plot in the visual directly above is the loan status for the best 
possible combination of prosper rating and score (AA and 9-11) while the second plot is the loan status for the worst possible combination of prosper rating and score (HR and 1-3). Clearly there is a higher precedence of loans being past 
due, defaulted and charged off for the worst combination than the best 
combination.  There is also a higher percentage of loans which are completed in 
the best combination versus the worst combination.  This would seem to point to 
a relationship between these three variables.  I will be examining this further 
in the bi-variate and multi-variate portion of my analysis.  

```{r, echo=FALSE, message=FALSE, warning=FALSE,  days_delinquent_comparison}
# Plotting two histograms of days_delinquent; one for the best possible 
# combination of prosper rating and prosper score (AA, 9-11).  The other for the 
# worst possible combination (HR, 1-3).  This is to see if there may be a 
# relationship between these three variables.

# Set conditions. Again, I limit things to cases where the days_delinquent
# is greater than 0 and the loan status is not defaulted or charged off.
best_combo <- (prosp_2009$prosper_score == "9-11" & 
                 prosp_2009$prosper_rating == "AA" & 
                 prosp_2009$days_delinquent > 0 &
                 prosp_2009$loan_status != "Defaulted" &
                 prosp_2009$loan_status != "Chargedoff")
worst_combo <- (prosp_2009$prosper_score == "1-3" & 
                 prosp_2009$prosper_rating == "HR"& 
                 prosp_2009$days_delinquent > 0 &
                 prosp_2009$loan_status != "Defaulted" &
                 prosp_2009$loan_status != "Chargedoff")

# Create the histogram of proportion of borrowers for best and worst possible
# combinations.  I pick a max of 125 since all the data is below this number (References 20 and 21).  I used coord_cartesian so that I wouldn't shave off any data.

q1 <- ggplot(subset(prosp_2009, best_combo), aes(days_delinquent)) + 
        geom_histogram(binwidth = 1) + coord_cartesian(xlim = c(0,125))

q2 <- ggplot(subset(prosp_2009, worst_combo), aes(days_delinquent)) + 
        geom_histogram(binwidth = 1) + coord_cartesian(xlim = c(0,125))

# Plot the charts on a grid (Reference 22)

grid.arrange(q1, q2, ncol = 1)

# Get summary of data for the best and worst combo
summary(subset(prosp_2009, best_combo)$days_delinquent)
summary(subset(prosp_2009, worst_combo)$days_delinquent)
```

The above two histograms are the distributions of days' delinquent under the 
best (AA and 9-11) and worst (HR and 1-3) possible combination of prosper scores and ratings as I did with the loan status variable.  As I did in the original plots of days' delinquent, I limited the data to cases where the days' 
delinquent was greater than 0 and to cases where the loan had not been charged 
off or defaulted.  Clearly there are fewer cases of days' delinquent for the  
best combination than the worst combination.  Looking at the summary however, 
the average number of days' delinquent is greater for the best case scenario 
than the worst case scenario.  A couple of things should be kept in mind.  The first is that it may be better to create a variable where the number of days' 
delinquent is divided by the number of days since the origination of the loan.  
As I mentioned before, someone may be thirty days' delinquent on a loan but be really close to finishing paying off the loan.  The second is that the number of borrowers' delinquent being greater in the worst combination case may simply be because Prosper assigned more borrowers this combination than they did borrowers the best combination.  It could be that prospers ratings and scores are good at predicting loan status but not good at predicting days' delinquent.  Again, I'm 
not as concerned about predicting this variable but it is something to look at 
in future analyses. 

# Summary Observations about Univariate Analysis

This concludes the univariate portion of the analysis.  The following are
some summaries about what I have observed so far.

## Structure of the dataset and summary of results

My dataset had 81 variables with 113,937 observations.  I only decided to
consider 11 total variables including loan_status, employment_status,   income_range, employment_status_duration, credit_score_range_lower, borrower_apr debt_to_income_ratio, prosper_score, prosper_rating, days_delinquent and is_homeowner.

The variables loan_status, employment_status, income_range, prosper_score, prosper_rating and is_homeowner are all factor variables (note that I turned prosper_score into a factor variable from a number variable) with the following levels:

**loan_status:** Defaulted, Chargedoff, Cancelled, Past Due, Current, Completed

**employment_status:** , Employed, Full-time, Not available, Other, Part-time,
                       Retired, Self-employed
                     
**income_range:** $0, $1-24999, $25000-49999, $50000-74999, $75000-99999, 
                   $100000+
                     
**prosper_score:** 1-3, 4, 5, 6, 7, 8, 9-11

**prosper_rating:** AA, A, B, C, D, E, HR

**is_homeowner:** True, False

Most of the borrowers are in a Current status with their loans while around
15% of total borrowers have either Defaulted or been charged off.  The
employment status variable is very vague.  Most of the borrowers have a status
of employed but it is not clear what this means (full-time or part-time?).
Around 30% of borrowers have an income in the ranges of $25000-49999 and 
$50000-74999 (note that these proportions are only for data for which the income is verifiable and known).  Most of the borrowers are either in the 1-3 or 9-11 range of prosper scores but if all the scores are considered separately, most of the borrowers have either a 4 or 6 rating.  Most of the borrowers have a loan status of C.  And around an equal number of borrowers are homeowners.  The
combination of prosper score and prosper rating appeared to have an effect on
loan status.

The variables employment_status_duration, credit_score_range_lower,
debt_to_income_ratio and borrower_apr are all right-skewed and I think there is
some overlap between them.  I think they are related to each other and I will 
be examining this question in the bi-variate analysis.

### Main features of the Prosper loan data
The main features of interest in the selected data are loan status, prosper 
score and prosper rating.  Prosper score is a variable that Prosper assigns to loans to determine the risk they pose to investors (Reference 5).  This score takes into account a number of variables such as debt to income ratio, loan payment performance on prior loans, credit card utilization, number of 
delinquent accounts and others (Reference 5).  Prosper rating is another 
variable Prosper uses which is based on the Prosper score and credit score (Reference 7).  Both these are variables Prosper uses to uniquely judge the risk of a potential loan, so I want to see how well they do at associating themselves with borrowers who Default, are charged off or who complete the loan.  I have already done this somewhat in the second to last graph of the univariate 
analysis.  I looked at the loan status bar chart for the best and worst possible combinations of prosper score and rating.  It was clear that the worst possible combination had higher rates of Defaulted and Chargedoff loans and a lesser rate of completed loans relative to the best combination.

### Supporting features of Prosper loan data that will aid in investigation of main features.

I think the question of whether a borrower is a homeowner will aid in my
investigation.  I want to see which condition (owning or not owning a home) is
associated with higher success and failure rates for paying back the loans.  If 
a borrower owns a home, that means a bank has already approved them for a loan
after examining their credit history.  This would be a good sign that the 
borrower should be trusted.  I also think borrower apr, credit score, debt-
to-income ratio and employment status duration will be beneficial to my investigation.  I think they are all related to each other and I will try to eliminate at least one of them in the bi-variate analysis portion of the investigation.  I wanted to see if employment status would support my investigation but the categories seem rather vague and are probably not useful 
at predicting loan payback success or failure.  I will also look at how income
range affects loan status.  I predict that higher incomes will be associated
with greater loan payback success. 

### Unusual observations from the Univariate Analysis and ways I adjusted the data

There were three main results from the Univariate analysis that I thought
were unusual.  The first was the shape of the debt-to-income ratio histogram.
I initially thought that the less that number was, the more successful borrowers
would be at paying back loans.  But I think that there is a lot of overlap
between the shape of the credit score histogram and that of the debt-to-income
ratio.  I have not considered these variables together, but my guess is that the
reason an individual may have a higher than average debt-to-income ratio is 
because they have a higher salary and can take on more debt.  Even though the 
the ratio may be higher, they will have more funds to pay back loans and will be
more successful at paying back the loans.  I need to confirm this but that is 
my guess.  The shape of this curve could also be due to borrowers having a large
student loan.  This would cause the debt-to-income ratio to be higher than 
average but if borrowers are in a highly paying field (law or medicine), they
will still be able to successufully pay back the loans.  

The second result that I thought was unusual was the shape of the borrower apr
histogram.  This too was skewed to the right, but if my guess that the credit
score and debt-to-income ratio histograms overlap is correct, this curve should
have been skewed to the left.  The borrowers with higher credit scores should
qualify for lower interest rates (Reference 10).  Again, I need to graph these variables against each other to truly know what's going on.  

The third result I thought was unusual was when I compared the distribution of
days' delinquent between the best combination of prosper score and rating and
the worst combination of prosper score and rating.  I thought the average
days' delinquent would be greater for the worst combination than the best 
combination but the relationship was reversed.  I think to truly analyze this
variable, it needs to be divided by number of days since loan originated.  As
I said in the analysis, a  borrower who is 30 days delinquent but 2 years into
paying back the loan will be viewed differently than a borrower who is 20 days
delinquent and only 3 months into paying back the loan.

I combined some of the categories in loan status, income range and prosper score.  I also only found days' delinquent for cases where the borrower hadn't defaulted or been charged off and for cases where the days' delinquent was greater than 0.  For employment duration, I let borrowers who were not 
employed have a duration of 0 and I did not consider employment statuses of 
retired, other, not available and blank.  

I combined all the Past Due categories to Past Due in the loan status variable
because I'm mainly only interested in the Completed, Chargedoff and Defaulted
categories for this variable.  I combined these categories to lessen the clutter
of the bar chart. 

I combined prosper scores 1-3 into one category and prosper scores 9-11 into
one category.  I did this because I thought 11 categories seemed too much and
I don't need all of them to gain insight into how prosper score may determine
loan status.

I only found the days' delinquent histogram for borrowers who had greater than
0 days' delinquency because if I hadn't, the bin at 0 would have dominated the
rest of the histogram and I couldn't have made an observations about the data.
I also only considered cases where the borrower hadn't defaulted or been 
charged off because these cases will be irrelevant to investors as they consider days' delinquent.  They have already reached a final status and I am predicting these statuses elsewhere.

For income range, I only considered incomes which could be verified because
that's the income that could be trusted.  I also combined the 0$ and Not
employed categories since they mean the same thing.  

For employment duration, I let borrowers who were not employed have a duration
of 0 because the original variable was employment status duration and I 
wanted to consider how long a borrower had been emloyed.  The same logic holds
for why I didn't consider borrowers who had retired.  I also did not consider
employment statuses of blank, not available and other.

## A note about the days' delinquent variable
This analysis will not consider the days' delinquent variable going forward.
This variable was an extra independent variable that I wanted to consider but
upon looking at the histograms for the best and worst possible combinations of
prosper score and rating, I have decided that more variables would need to be
added and that this variable would be worth it's own analysis at some point in
the future.  The only independent variable I will consider is loan status for 
the remainder of the analysis.  

# Bivariate Plots Section

First, I will look at some matrices of variables plotted against each other
to see if I can find any relationships between the variables.  I will see if any
of the independent, non-categorical variables are correlated with themselves and if there is a pattern for each of them with the loan status variable.  I will
also see if there is a relationship between loan status and the categorical
variables.  Finally, I will see if there is a relationship between loan status 
and prosper score/rating.  These matrices will give me an idea about what to 
expect as I make the bivariate plots in this section.

```{r, echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, fig.height = 8, fig.width = 11, Bivariate_Plots_GGally_non_categorical_loan_status}

# I am going to make scatter plot matrices but to make them easier to see
# and load, I am going to divide them up into four matrices.  The first
# is only for non-categorical independent variables for which I want to 
# see if relationships exist (borrower apr, credit score, etc...) and also
# for the dependent variable loan_status to see if there is a relationship
# between loan_status and each of the independent variables.

# The second will be for loan status against all of the categorical variables 
# (income range, is homeowner, etc...)

# The third will be for data pre-2009 and I will only look at prosper score
# and prosper rating

# Plot a grid of each non-categorical independent variable and loan status to see if there are any relationships between the independent variables and between the independent variables and loan status (References 28 and 29).
ggpairs(subset(prosp_sub, select = -c(employment_status, income_range,
                                      income_verifiable, prosper_score,
                                      prosper_rating, is_homeowner,
                                      days_delinquent)))
```

From the matrix given, there does not appear to be any strong linear correlations between the variables.  There are no monotonic relationships 
between the variables (this is confirmed with the pearson correlation
coefficients given) (Reference 11).  I do however, want to take a closer look at debt_to_income ratio versus credit_score_range_lower. 

In terms of the relationship between loan status and the independent variables,
there appears to be an expected relationship between loan status and 
borrower apr/lower range of credit score.  Completed and current loans appear
to have the lowest median borrower apr even though there is a larger spread
for completed loans from the box plots.  Past due has the highest median apr
with the two worst possible cases, defaulted and chargedoff, possessing the
third and second highest median apr, respectively.  Higher credit score
was also associated with loan payback success (either completed or current)
while lower credit score was associated with failure (either defaulted or 
charged off).  It will be interesting to look at these variables and the others
further in the bi-variate analysis.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height = 8, fig.width = 11, Bivariate_Plots_GGally_categorical_loan_status}

# Plot a grid of each categorical independent variable and loan status to see if there are any relationships between the independent variables and loan status (References 26 and 27).
ggpairs(subset(prosp_sub, select = c(loan_status, employment_status,
                                     income_range, income_verifiable,
                                     prosper_score, prosper_rating,
                                     is_homeowner)))
```

From the above matrix of variables plotted against each other, it is difficult
to determine patterns for loan_status against each of the independent variables
because these are basically faceted bar charts.  I will need to look at these
relationships individually. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height = 8, fig.width = 11, GGally_categorical_loan_status_prosper}

# Plot a grid of each non-categorical independent variable and loan_status to see if there are any relationships between the independent variables and loan_status (References 28 and 29).
ggpairs(subset(prosp_2009, select = c(loan_status,
                                      prosper_rating, prosper_score)))

```

From the above scatterplot matrix, for loan status, prosper rating and 
prosper score, there are some expected and unexpected results.  For a loan
status of completed, prosper score category of 9-11 has the highest percentage
of borrowers (to be expected as these are the lowest risk loans).  A loan
status of defaulted has about equal counts across all prosper scores but this
is difficult to see in the matrix and will need to be further examined in the
bi-variate analysis.  A prosper score of 1-3, 5 and 6 has highest proportions of
borrowers with a loan status of chargedoff.  

A surprising result was that a prosper rating of D had the highest proportion
of borrowers with a completed loan.  The three worst prosper ratings (HR, E, and D) had the highest proportion of borrowers who had been chargedoff.  As with
prosper score, prosper ratings effect on borrowers who had defaulted was difficult to see.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height = 10, fig.width = 11, debt_to_income_ratio_vs_credit_score}

# In this chunk I examine the relationship between debt_to_income_ratio and
# lower range of credit score.  I do this first by finding an initial,
# un-changed scatterplot.  I then deal with overplotting issues and outliers.
# Finally, I find the mean and median of debt_to_income_ratio at each credit
# score and then graph them all on the same plot.

# Plot initial form of scatterplot for debt_to_income_ratio versus 
# credit_score_range_lower (Reference 30).

q1 <- ggplot(aes(x = credit_score_range_lower, y = debt_to_income_ratio), 
             data = prosp_sub) + geom_point()

# Set values which will be limits for scatterplot without data points at 
# debt to income ratio of 10 and credit score range lower of 0 using
# quantile (Reference 31).
x_lim = c(quantile(prosp_sub$credit_score_range_lower,0.01, na.rm='True'), 800)
y_lim = c(0,quantile(prosp_sub$debt_to_income_ratio,0.99, na.rm='True'))

# Graph scatter plot where the data is jittered and with a transparency of
# 1/20 to correct for overplotting (Reference 32).  I also cut off the data at debt to income ratio of 10 and credit score range lower of 0 (Reference 21). They are outliers even though the data is good.  I set position_jitter with an h of 0 to keep the data in the vertical direction from becoming negative (Reference 33).

q2 <- ggplot(aes(x = credit_score_range_lower, y = debt_to_income_ratio), 
       data = prosp_sub) + geom_jitter(alpha = 1/20,                                   position = position_jitter(h = 0)) + 
       coord_cartesian(xlim = x_lim, ylim = y_lim)

# Now I will create a dataframe of conditional means where I take the mean and median of debt to income ratio for each credit score since the ratios seem
# grouped about certain credit scores (References 34 and 35)

prosp_sub.cs <- prosp_sub %>%
  na.omit() %>%
  group_by(credit_score_range_lower) %>%
  summarise(debt_income_mean = mean(debt_to_income_ratio),
            debt_income_median = median(debt_to_income_ratio),
            n = n()) %>%
  arrange(credit_score_range_lower)

# Graphs q3 and q4 represent the mean and median of the debt to income ratio
# for each credit score as line graphs (Reference 37)

 q3 <- ggplot(aes(x = credit_score_range_lower, y = debt_income_mean), 
       data = prosp_sub.cs) + geom_line() 
 
 q4 <- ggplot(aes(x = credit_score_range_lower, y = debt_income_median), 
       data = prosp_sub.cs) + geom_line() 
 
 # Plot the graphs on the same grid
 grid.arrange(q1, q2, q3, q4, ncol = 1)

 # Find pearson correlation coefficient between debt_to_income_ratio and
 # credit_score_range_lower.  I set use to be "complete.obs" because there is
 # missing data in the two variables (Reference 36).
cor(prosp_sub$credit_score_range_lower, prosp_sub$debt_to_income_ratio, 
    use = "complete.obs")
```

From the above grid of graphs and the pearson correlation coefficient given, it
is easy to see that there is no correlation between the lower range of credit
score and debt_to_income_ratio.  The data is certainly not monotonic.  It seems
from the last three graphs that the data is almost parabolic (except for the two points closer to the lower end of credit score).  For the second graph, I 
decided to cut off the data at debt_to_income_ratio of 10 and
credit_score_range_lower of 0.  The last two graphs represent the conditional
means and medians of debt_to_income_ratio at each of the credit scores since
the credit scores seem to be in discrete values.  I left the debt_to_income_
ratio values at 10 and the credit_score_range_lower values of 0 in these 
calculations because even though they are outliers, I still think those pieces
of data are valid based off the univariate analysis.  Since this data is not
monotonic, I will need to consider both variables as I proceed through the bi-
variate analysis.

From the above grid of scatterplots and line graphs, it appears that there are three regions. The first for which credit scores are relatively bad but
debt-to-income ratios are low.  The second for which debt-to-income ratios have a peak mean and median but with average credit scores.  And the third for which
debt to income ratios are also low but credit scores are very good.  I am 
guessing that the two regions on the end are associated with the lowest
and highest income ranges possible.  I am now going to look at a box plot
of credit score versus income range to see if my guess is correct.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height = 8, fig.width = 11, credit_score_vs_income_range}

# This chunk creates a box plot of credit score versus income range

# Get the box plot only for borrowers for which the income is verifiable 
# and for which the income range is not NA (References 38 and 39)

ggplot(subset(prosp_sub, income_verifiable == 'True' &
                income_range != 'NA'), 
                aes(x = income_range, y = credit_score_range_lower)) +
                geom_boxplot() + 
                stat_summary(fun.y=mean, geom="point", color = "red",
                             shape = 4, size=3)

# I'm going to get a summary to go along with the box plot grouped by 
# income range, but I'm going to do it by creating a new dataframe 
# equivalent to the subsetted dataframe I used for the box plot (only 
# considering income that is verifiable and without NA's).

prosp_income <- subset(prosp_sub, income_verifiable == 'True' &
                income_range != 'NA') 

# Get summaries of credit_score_range_lower grouped by income_range
# (Reference 40)
by(prosp_income$credit_score_range_lower, prosp_income$income_range, 
   summary)
```

From the above box plot and summaries, we have what is to be expected.  The median credit score for borrowers increases as income range increases.  The means (red x) also increase as income range increases.  Because of this, the portion of the debt_to_income_range versus credit score graph in the far left is probably for borrowers with an income range of $0 and $1-24,999 while borrowers with an income range at or greater than $100,000 dollars probably dominate the right side of the scatter plots.  Income reduction is a big reason borrowers go 
bankrupt so this box plot does not surprise me (Reference 12).

Now I will look at how loan status is related to each of the non-categorical
variables by looking at box plots of the data.  First I will consider 
employment duration.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height = 8, fig.width = 11,employment_duration_vs_loan_status}

# This chunk creates a box plot of employment duration versus loan status

# Get the box plot only for borrowers for which the employment status is either "Employed", "Full-time", "Not employed", "Self-employed" or "Part-time" as I did in the uni-variate case. 

# Set employment condition
condition <- c("Employed", "Full-time", "Not employed", "Self-employed",
               "Part-time")

# Find box plot for the given employment condition.  I also zoomed in on
# the y axis to better see the medians and where they are (References 38 and 39).
ggplot(subset(prosp_sub, employment_status %in% condition), 
                aes(x = loan_status, y = employment_status_duration)) +
                geom_boxplot() + 
                stat_summary(fun.y=mean, geom="point", color = "red",
                             shape = 4, size=3) + 
                coord_cartesian(ylim = c(0,400))

# I'm going to get a summary to go along with the box plot grouped by 
# loan status, but I'm going to do it by creating a new dataframe 
# equivalent to the subsetted dataframe I used for the box plot (only 
# considering employment statuses I stated previously).

prosp_edur <- subset(prosp_sub, employment_status %in% condition) 

# Get summaries of employment duration grouped by loan status
# (Reference 40)
by(prosp_edur$employment_status_duration, prosp_edur$loan_status, 
   summary)
```

Generally based on the above box plots and summary I get results I expected.
The lowest employment durations (mean and median) are for Defaulted and 
Chargedoff borrowers.  Defaulted has the lowest mean employment duration while
Chargedoff has the lowest median employment duration.  This relationship isn't
too strong though as the difference in median employment duration between 
Chargedoff and Completed borrowers is only 2 days.  The difference in means is
even less.  A statistical test for significance would need to be conducted to
see if these differences are significant (my guess is that they are not). In
contrast, the difference in lower range of credit score between borrowers with
at or greater than $100,000 dollars and those with income range of $1-24,999 is
41.7.  But a statistical test for significance is still needed. 

Now get box plots of credit score lower range versus loan status.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height = 8, fig.width = 11,credit_score_vs_loan_status}

# This chunk creates a box plot of credit score lower range versus loan status

# Find box plot. I also zoomed in on the y axis to better see the medians and
# where they are (References 38 and 39).
ggplot(prosp_sub, aes(x = loan_status, y = credit_score_range_lower)) +
                  geom_boxplot() + 
                  stat_summary(fun.y=mean, geom="point", color = "red",
                               shape = 4, size=3) + 
                  coord_cartesian(ylim = c(500,800))

# Get summaries of credit score lower range grouped by loan status
# (Reference 40)
by(prosp_sub$credit_score_range_lower, prosp_sub$loan_status, 
   summary)
```

In general, this box plot and summaries went as expected.  Not including 
cancelled loans, loans of Defaulted had the lowest mean and median lower range
of credit score.  Loans of Chargedoff had the second lowest mean and median
lower range of credit score (again, not including cancelled loans).  Loans
of Current had the highest and loans of Completed had the second highest median (tied with Past Due).  Past Due did have the second highest mean credit score but Completed still had the third highest and was greater than the Defaulted and Chargedoff mean credit scores.  This relationship seems to be stronger than employment duration but as with all the differences in means, a statistical test for significance is needed. 

Now get box plots of debt to income ratio versus loan status.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height = 8, fig.width = 11,debt_to_income_ratio_vs_loan_status}

# This chunk creates a box plot of debt to income ratio versus loan status

# Find box plot. I also zoomed in on the y axis to better see the medians and
# where they are (References 38 and 39).

ggplot(prosp_sub, aes(x = loan_status, y = debt_to_income_ratio)) +
                  geom_boxplot() + 
                  stat_summary(fun.y=mean, geom="point", color = "red",
                               shape = 4, size=3) +
                  coord_cartesian(ylim = c(0,0.5))

# Get summaries of debt to income ratio grouped by loan status
# (Reference 40)
by(prosp_sub$debt_to_income_ratio, prosp_sub$loan_status, 
   summary)
```

With the debt_to_income_ratio versus loan_status box plots, there were some
expected and surprising results.  The means of debt_to_income_ratio went as
I expected with the highest mean ratio being for Defaulted loans and the second
highest mean ratio being for Chargedoff loans.  I had originally thought this 
might be the case before looking at the credit score and debt to income ratio
histograms in the univariate case and now with the box plots my thoughts are
confirmed at least by the means (again, a significance test still needs to be
performed).  The lowest mean is for Current loans and the second lowest is for
Completed.  The medians also follow a similar pattern except that the median
ratio for Defaulted and Chargedoff is less than Current.  Completed loans do have the lowest median debt to income ratio for loan statues outside those that are Cancelled.  An individual with a low debt_to_income_ratio should have an
easier time paying back loans and the data mostly points to this.

Now I will look at how borrower apr is affected by loan status.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height = 8, fig.width = 11,borrower_apr_vs_loan_status}

# This chunk creates a box plot of borrower apr versus loan status

# Find box plot. I also zoomed in on the y axis to better see the medians and
# where they are (References 38 and 39).

ggplot(prosp_sub, aes(x = loan_status, y = borrower_apr)) +
                  geom_boxplot() + 
                  stat_summary(fun.y=mean, geom="point", color = "red",
                               shape = 4, size=3) 
#+
 #                 coord_cartesian(ylim = c(0,0.5))

# Get summaries of borrower apr grouped by loan status
# (Reference 40)
by(prosp_sub$borrower_apr, prosp_sub$loan_status, 
   summary)
```

The results of the summary and box plots above follow what I expected.  For
both the mean and median, the borrower apr increases as the loan status gets
dire.  Borrowers with a higher apr should have a harder time paying back
loans so it is to be expected that they will have a higher rate of defaulting
and being chargedoff.  The one exception was that a status of Past Due had the
largest mean and median borrower apr but several of these borrowers may be close
to defaulting.  And they should have a higher borrower apr on average than those
who are current or completed.

Next, I will look at how loan status is affected by the categorical variables I
have considered(is_homeowner, employment_status, income range, prosper score,
and prosper rating).

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height = 8, fig.width = 11, loan_status_employment_status_graph}
# Plotting a bar graph of loan_status; proportions for each category filled
# by the proportion of each bar under each employment status (References 17 and 18). Using the subsetted dataframe I created earlier, only considering statues of Employed, Full-time, Not employed, Part-time and Self-employed.

ggplot(prosp_edur, aes(loan_status, fill = employment_status)) + 
  geom_bar(aes(y=..count../sum(..count..))) + ylab('Proportion of Borrowers') 

# Get summaries of loan status grouped by employment status
# (Reference 40)
by(prosp_edur$employment_status, prosp_edur$loan_status, 
   summary)
```

From the above bar chart and summaries there is the expected result that most of the borrowers with loan status of Completed are Full-time.  The overwhelming majority of borrowers with a Current status are Employed but as I've mentioned
before, this definition is very vague.  Most of the Defaulted and Chargedoff
loan statuses have borrowers who are Full-time.  Based on the research I've
done, employment status isn't so much a predictor of loan payback success as 
income range is.  The one conclusion I think can be gathered from this is that
it is good to have a full-time job to pay back a loan, but from the results
this is obviously not always true and I think income range will be a better
predictor (Reference 12).

Next, I will look at bar chart of loan status filled by income range to see
which income ranges are most associated with each loan status.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.height = 8, fig.width = 11, loan_status_income_range_graph}
# Plotting a bar graph of loan_status; proportions for each category filled
# by the proportion of each bar under each income range (References 17 and 18). Using the subsetted dataframe I created earlier, only considering income that is verifiable and is not 'NA'.

ggplot(prosp_income, aes(loan_status, fill = income_range)) + 
  geom_bar(aes(y=..count../sum(..count..))) + ylab('Proportion of Borrowers') 

# Get summaries of loan status grouped by income range
# (Reference 40)
by(prosp_income$income_range, prosp_edur$loan_status, 
   table())
```

From the above bar chart, income ranges of greater than $75,000 make up a
greater percentage of the bars for loan statues of Completed and Current than
for loan statuses of Defaulted or Chargedoff.  Income ranges of $0-50,000 also
make up a greater percentage of all borrowers for Chargedoff and Defaulted loans
than for Current and Completed loans.  This should all be expected as having
more money will make it easier to pay back loans.  It has been shown that income
range plays a large part in the ability of borrowers to pay back loans (Reference 12) so this is not surprising.

```{r, echo=FALSE, message=FALSE, warning=FALSE, resources}
# Resources - code

# Reference 1: http://ggplot2.org/

# Reference 2: https://yihui.name/knitr/

# Reference 3: https://dplyr.tidyverse.org/

# Reference 4: https://stackoverflow.com/questions/29189663/trying-to-
# publish-an-r-notebook-and-keep-getting-the-same-error-error-in-contri

# Reference 5: http://kbroman.org/knitr_knutshell/pages/Rmarkdown.html

# Reference 6: https://stackoverflow.com/questions/5595512/what-is-the-
# difference-between-require-and-library

# Reference 7: http://rfunction.com/archives/1001

# Reference 8: https://stackoverflow.com/questions/6329962/split-code-over-
# multiple-lines-in-an-r-script

# Reference 9: http://rprogramming.net/read-csv-in-r/

# Reference 10: https://stat.ethz.ch/R-manual/R-devel/library/base/html/dim.html

# Reference 11: https://www.rdocumentation.org/packages/utils/versions/3.4.3/
# topics/str

# Reference 12: https://stackoverflow.com/questions/11488820/why-use-c-to-
# define-vector

# Reference 13: https://www.rdocumentation.org/packages/base/versions/3.5.0/
# topics/subset

# Reference 14: http://www.sthda.com/english/wiki/renaming-data-frame-columns-
# in-r

# Reference 15: https://stats.idre.ucla.edu/r/modules/factor-variables/

# Reference 16: https://stackoverflow.com/questions/32845303/using-logical-
# operators-with-characters

# Reference 17: https://stackoverflow.com/questions/36604127/creating-a-bar-
# plot-with-proportions-on-ggplot

# Reference 18: http://ggplot2.tidyverse.org/reference/geom_bar.html

# Reference 19: http://tallman-world.tumblr.com/post/89964965867/rhow-to-
# rotate-axis-labels-in-ggplot2

# Reference 20: http://ggplot2.tidyverse.org/reference/geom_histogram.html

# Reference 21: http://ggplot2.tidyverse.org/reference/coord_cartesian.html

# Reference 22: https://www.rdocumentation.org/packages/gridExtra/versions
# /2.3/topics/arrangeGrob

# Reference 23: https://stackoverflow.com/questions/2667673/select-first-4
# -rows-of-a-data-frame-in-r

# Reference 24: https://www.rdocumentation.org/packages/base/versions
# /3.5.0/topics/NA

# Reference 25: https://www.rdocumentation.org/packages/GGally/versions/1.3.2

# Reference 26: https://www.datamentor.io/r-programming/ifelse-function

# Reference 27: https://stackoverflow.com/questions/14708095/log10-
# transformation-in-r

# Reference 28: https://www.rdocumentation.org/packages/GGally/versions/1.3.2
# /topics/ggpairs

# Reference 29: https://stackoverflow.com/questions/5234117/how-to-drop-
# columns-by-name-in-a-data-frame

# Reference 30: http://ggplot2.tidyverse.org/reference/geom_point.html

# Reference 31: https://www.rdocumentation.org/packages/stats/versions/3.5.0/topics/quantile

# Reference 32: https://www.rdocumentation.org/packages/ggplot2/versions/2.2.1/topics/geom_jitter

# Reference 33: http://ggplot2.tidyverse.org/reference/position_jitter.html

# Reference 34: http://seananderson.ca/2014/09/13/dplyr-intro/

# Reference 35: https://stackoverflow.com/questions/26665319/removing-na-in-dplyr-pipe

# Reference 36: http://www.sthda.com/english/wiki/correlation-test-between-two-variables-in-r

# Reference 37: http://ggplot2.tidyverse.org/reference/geom_path.html

# Reference 38: http://t-redactyl.io/blog/2016/04/creating-plots-in-r-using-ggplot2-part-10-boxplots.html

# Reference 39: https://stackoverflow.com/questions/19876505/boxplot-show-the-value-of-mean/19876655

# Reference 40: https://www.statmethods.net/stats/withby.html

# NOTE: This is the Resources list only for the code chunks.  I am placing this list inside of this chunk so that they do not appear when knitting the HTML 
# file (for users who want to do that at the end). The only resources I want to appear when knitting the HTML file are those referenced inside the file and 
# meant to be visible (outside the R chunks).
```

# Resources

Reference 1: https://www.prosper.com/home/about

Reference 2: https://www.kaggle.com/jschnessl/prosperloans/feed

Reference 3: https://docs.google.com/spreadsheets/d/1gDyi_L4UvIrLTEC6Wri5nbaMmkGmLQBk-Yx3z0XDEtI/edit#gid=0

Reference 4: https://www.investopedia.com/articles/00/091800.asp

Reference 5: https://www.prosper.com/plp/general-prosper_score/

Reference 6: https://www.investopedia.com/terms/d/delinquent.asp

Reference 7: https://www.prosper.com/Downloads/Legal/Prosper_Prospectus_2018-04-30.pdf

Reference 8: https://www.investopedia.com/terms/a/apr.asp

Reference 9: https://help.lendingclub.com/hc/en-us/articles/216127747-What-is-the-difference-between-a-loan-that-is-in-default-and-a-loan-that-has-been-charged-off-

Reference 10: https://www.thebalance.com/how-your-credit-score-influences-your-interest-rate-960278

Reference 11: https://statistics.laerd.com/statistical-guides/spearmans-rank-order-correlation-statistical-guide.php

Reference 12: https://www.thesimpledollar.com/six-factors-that-make-you-more-likely-to-go-bankrupt/